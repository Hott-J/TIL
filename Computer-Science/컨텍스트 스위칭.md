# 스레드 컨텍스트 스위칭 vs 프로세스 컨텍스트 스위칭



## 컨텍스트 스위칭
CPU/코어에서 실행 중이던 프로세스/스레드가 다른 프로세스/스레드로 교체되는 것



**컨텍스트**
- 프로세스/스레드의 상태

- CPU, 메모리 등등
    - CPU: register들이 있다
    
    

**컨텍스트 스위칭이 필요한 이유**
- 여러 프로세스/스레드를 동시에 실행시키기 위해서



**언제 발생?**
- 주어진 time slice(quantum)를 다 사용했거나 IO작업을 해야하거나 다른 리소스를 기다려야 하거나 등



**누구에 의해 실행?** (트리거가 아님)
- OS 커널
    - 각종 리소스를 관리/감독하는 역할



**구체적으로 어떤 과정으로 일어나는가?**
- 다른 프로세스끼리 스위칭인지 같은 프로세스의 스레드끼리 스위칭인지에 따라 다르다
    - 프로세스 컨텍스트 스위칭 vs 스레드 컨텍스트 스위칭



**프로세스 컨텍스트 스위칭 vs 스레드 컨텍스트 스위칭**
*공통점*

- 커널 모드에서 실행 (유저모드에서 프로세스가 동작하다가 P1, P2로 넘어갈때 유저모드 -> 커널모드로 넘어감)

- CPU의 레지스터 상태를 교체
  - 레지스터는 각종 명령어들을 수행하기 위해 값들을 저장해둠
  
  - P1 -> P2 될때, P1 레지스터 상태값들을 어딘가에 저장해둬야함. 그래야 P2끝나고 P1돌아와서 다시 이어서 수행
  
    

*차이점*

- 프로세스 컨텍스트 스위칭은 가상 메모리 주소 관련 처리를 추가로 수행

- 왜냐하면, 프로세스는 서로 다른 메모리 영역이므로, 메모리 새로운 주소를 매핑하고 이에 대한 연산작업을 다시 수행해야함
    - MMU, TLB를 비워줘야함
    - MMU가 새로운 프로세스 메모리를 보도록
    - TLB는 캐싱같은건데 이를 비워줘야함
    - 위 작업을 해주지 않으면 P2시작했는데, P1 메모리영역에 접근할 수 있다
    
- 동일 프로세스내 다른 스레드 컨텍스트 스위칭

- ![image](https://user-images.githubusercontent.com/47052106/171000101-71927314-7b89-4013-ab8f-150fe5732f22.png)

- 서로 다른 프로세스내 스레드 컨텍스트 스위칭

- ![image](https://user-images.githubusercontent.com/47052106/171001025-2c7f20cb-12e3-4e44-a766-637a35cefe11.png)
    - 초록색 부분은 메모리 관련된 처리. 스위칭되서 새롭게 소속된 프로세스가 어디 메모리에 있는지 알아야함
    
    

**스레드 컨텍스트 스위칭이 더 빠른 이유는?**
- 메모리 주소 관련 처리는 하지 않기 때문에
- 스레드들은 같은 메모리 공간을 공유하고 있기 때문에



**컨텍스트 스위칭이 미치는 간접적인 영향은?**
- 캐시 오염

- 컨텍스트  스위칭이 되면, 어차피 이전에 실행됬던 정보들이 캐시에 있으므로 다른 프로세스에 대한 정보는 캐시에 없다
  - 그나마, 같은 프로세스내 스위칭인 스레드 컨텍스트 스위칭이라면 캐시에 있을 가능성이 있다 (같은 메모리를 공유하므로)
  - 즉, 컨텍스트 스위칭이 일어난 직후에는 캐시에 없을 확률이 높고 메모리에 접근해야한다
  - 그래서, 컨텍스트 스위칭이 일어나면 TLB Cache를 날려버리는 운영체제도 있음
  
  

**유저 관점에서 컨텍스트 스위칭이란?**
- 순수한 오버헤드